## Cluster Resources

[Red Hat Docs](https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html/disconnected_environments/mirroring-in-disconnected-environments#oc-mirror-updating-cluster-manifests-v2_about-installing-oc-mirror-v2){:target="_blank"}

From your `oc mirror` command, you could have the following files in your working-dir i.e. `/opt/4.17-mirrordata/working-dir/cluster-resources/`. It all depends on what you mirrored.

  - `idms-oc-mirror.yaml`: This is a list of mappings between the original public registry and your local registry for all images that are identified by their digest (ImageDigestMirrorSet).
  - `itms-oc-mirror.yaml`: This is a list of mappings between the original public registry and your local registry for all images that are identified by their tag (ImageTagMirrorSet).
  - `cs-redhat-operator-index-v4-17.yaml`: This is the CatalogSource for RedHat Operators. 
      
    !!! note
        Rename the catalog source in the YAML file from cs-redhat-operator-index-v4-17 to redhat-operators as many operators reference this exact catalog source name.
  
  - `cs-certified-operator-index-v4-17.yaml`: This is the catalog for operators certified by Red Hat but not necessarily developed by Red Hat.
  - `cs-community-operator-index-v4-17.yaml`: This is the catalog source for all community based operators.

    !!! info
        If you have any **ClusterCatalogs** i.e `cc-redhat-operator-index-v4-17.yaml`, they will only work on OpenShift 4.18 or newer. Ignore errors from ClusterCatalogs when applying resources if you are on an older version of OpenShift

        This is due to changes in the Operator Lifecycle Manager (OLM) architecture moving from v0 to v1 [Red Hat Docs](https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/extensions/catalogs){:target="_blank"}

## Patch the OperatorHub
Before importing these catalog sources, it is necessary to disable all default catalog sources with this command (as they will not work in a disconnected environment)
```bash
$ oc patch OperatorHub cluster --type json -p '[{"op": "add", "path": "/spec/disableAllDefaultSources", "value": true}]'
operatorhub.config.openshift.io/cluster patched
```

## Configure the cluster to use the resources you mirrored
Apply the cluster recources generated by the oc-mirror plugin. This will make your cluster aware of the catalog resources we mirrored earlier so you can utilze OperatorHub to install operators.
```bash
$ cd /opt/4.17-mirrordata/working-dir

$ oc apply -f cluster-resources/
catalogsource.operators.coreos.com/cs-certified-operator-index-v4-17 created
catalogsource.operators.coreos.com/cs-community-operator-index-v4-17 created
catalogsource.operators.coreos.com/cs-redhat-operator-index-v4-17 created
catalogsource.operators.coreos.com/redhat-operators created
imagedigestmirrorset.config.openshift.io/idms-operator-0 configured
imagetagmirrorset.config.openshift.io/itms-operator-0 configured
imagetagmirrorset.config.openshift.io/itms-generic-0 configured
```

Verify the CatalogSource has been installed
```bash
$ oc get catalogsource -A
NAMESPACE               NAME                                DISPLAY   TYPE   PUBLISHER   AGE
openshift-marketplace   cs-certified-operator-index-v4-17             grpc               2d
openshift-marketplace   cs-community-operator-index-v4-17             grpc               2d
openshift-marketplace   redhat-operators                              grpc               2d
```

Verify that the ImageDigestMirrorSet resources are successfully installed
```bash
$ oc get imagedigestmirrorset
NAME                  AGE
idms-operator-0       2d
idms-release-0        2d
image-digest-mirror   2d
```

Verify that the ImageTagMirrorSet resources are successfully installed
```bash
$ oc get imagetagmirrorset
NAME             AGE
itms-generic-0   2d
itms-release-0   2d
```
