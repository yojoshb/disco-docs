## Mirroring images from disk to your mirror

[Red Hat Docs](https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html/disconnected_environments/mirroring-in-disconnected-environments#disk-mirror-v2_about-installing-oc-mirror-v2){:target="_blank"}

Now that the images are on the disk and you have a target registry with push/pull permissions to mirror to, we can mirror them to your registry

- Specify the image set configuration file that you brought over or created. This example assumes that it is in `/opt/4.17-mirrordata/imageset-config.yaml`. If you named your's differently, sub in your name and path of the file.
- Specify the target directory where the `mirror_000001.tar` file is. The target directory path must start with `file://`. This procedure assumes you want to upload the mirror_000001.tar **from** `/opt/4.17-mirrordata/`.
    - The target directory will also hold the `working-dir` environment. This directory contains the various necessary data to build, update, and maintain cluster resources. Keep this directory safe, and do not modify it. It will be used again for updates and additions to your cluster
- Specify the registry you will be mirroring the images to. In this example `registry.example.com:8443/` is our registry, and we will upload it to the `ocp` namespace in our registry.
- Be aware of the caching system, this will also take up considerable space on the disk depending on how many images are being uploaded to your mirror. Caching still occurs with the 'disk to mirror' workflow.
  
!!! question "Caching"
    - How does the cache work?
        - It's like a local registry, it can take up additional disk space almost as large as the .tar that gets generated
    - Where is it saved?
        - By default in `$HOME/.oc-mirror/.cache`
    - Can I control where I want the cache to be stored?
        - Yes, you can pass `--cache-dir <dir>` which will change the cache location to `<dir>/.oc-mirror/.cache`
    - During the mirroring process, is there a way to resume if something goes wrong?
        - Yes, by re-running oc mirror
    - I intentionally canceled the task and re-ran the mirroring process, but it seemed to start from the beginning.
        - It goes through the images from your ISC but it won't pull them from the tarball if they're already in the cache. You can compare the elapsed times by running a second time with the images already cached.
    - The cache takes up a lot of disk space can it be deleted?
        - Yes the cache can be removed, oc mirror will just re-pull what's needed from the tarball

---
1. You have set the umask parameter to `0022` on the operating system that uses oc-mirror.
    ```{ .bash }
    umask 0022
    ```

1. Upload the updated images to your mirror
  ```{ .bash }
  oc mirror -c /opt/4.17-mirrordata/imageset-config.yaml --from file:///opt/4.17-mirrordata docker://registry.example.com:8443/ocp --v2
  ```
  If your mirror registry is using a self-signed certificate and your machine doesn't trust it internally use `--dest-tls-verify=false`
  ```{ .bash }
  oc mirror --dest-tls-verify=false -c /opt/4.17-mirrordata/imageset-config.yaml --from file:///opt/4.17-mirrordata docker://registry.example.com:8443/ocp --v2
  ```
  ```{ . .no-copy title="Example Output" }
  ...
  [INFO]   : === Results ===
  [INFO]   :  âœ“  185 / 185 release images mirrored successfully
  [INFO]   :  âœ“  8 / 8 operator images mirrored successfully
  [INFO]   :  âœ“  1 / 1 additional images mirrored successfully
  [INFO]   : ðŸ“„ Generating IDMS file...
  [INFO]   : /opt/4.17-mirrordata/working-dir/cluster-resources/idms-oc-mirror.yaml file created
  [INFO]   : ðŸ“„ Generating ITMS file...
  [INFO]   : /opt/4.17-mirrordata/working-dir/cluster-resources/itms-oc-mirror.yaml file created
  [INFO]   : ðŸ“„ Generating CatalogSource file...
  [INFO]   : /opt/4.17-mirrordata/working-dir/cluster-resources/cs-redhat-operator-index-v4-17.yaml file created
  [INFO]   : ðŸ“„ Generating ClusterCatalog file...
  [INFO]   : /opt/4.17-mirrordata/working-dir/cluster-resources/cc-redhat-operator-index-v4-17.yaml file created
  [INFO]   : ðŸ“„ Generating Signature Configmap...
  [INFO]   : /opt/4.17-mirrordata/working-dir/cluster-resources/signature-configmap.json file created
  [INFO]   : /opt/4.17-mirrordata/working-dir/cluster-resources/signature-configmap.yaml file created
  [INFO]   : ðŸ“„ Generating UpdateService file...
  [INFO]   : /opt/4.17-mirrordata/working-dir/cluster-resources/updateService.yaml file created
  [INFO]   : mirror time     : 14m20.563306852s
  [INFO]   : ðŸ‘‹ Goodbye, thank you for using oc-mirror
  ```

1. Verify the cluster resources were generated by oc mirror in the `working-dir/cluster-resources` directory, these new resources will need to be applied to the cluster so it knows about the new content in the registry
    ```{ .bash }
    ls /opt/4.17-mirrordata/working-dir/cluster-resources/
    ```
    ```{ . .no-copy title="Example Output" }
    cc-redhat-operator-index-v4-17.yaml  cs-redhat-operator-index-v4-17.yaml  idms-oc-mirror.yaml  itms-oc-mirror.yaml  signature-configmap.json  signature-configmap.yaml  updateService.yaml
    ```

## Inspect cluster resources
From your `oc mirror` command, you could have the following files in your working-dir i.e. `/opt/4.17-mirrordata/working-dir/cluster-resources/`. It all depends on what you mirrored. 

  - `idms-oc-mirror.yaml`: This is a list of mappings between the original public registry and your local registry for all images that are identified by their digest (ImageDigestMirrorSet).
  - `itms-oc-mirror.yaml`: This is a list of mappings between the original public registry and your local registry for all images that are identified by their tag (ImageTagMirrorSet).
  - `cs-redhat-operator-index-v4-17.yaml/cc-redhat-operator-index-v4-17.yaml`: This is the CatalogSource/ClusterCatalog for RedHat Operators. 
      
    !!! warning "Important!"
        Change the **name** the `cs-redhat-operator-index-v4-17.yaml/cc-redhat-operator-index-v4-17.yaml` catalog source ==in the YAML== file to `redhat-operators` as some operators are hardcoded reference this exact catalog source name. Examples below with the highlighted value:
        
        !!! tip
            Use a quick `sed` command to set the name in both files
            ```bash
            sed -i 's/name: cs-redhat-operator-index-v4-17/name: redhat-operators/' /opt/4.17-mirrordata/working-dir/cluster-resources/cs-redhat-operator-index-v4-17.yaml
            sed -i 's/name: cc-redhat-operator-index-v4-17/name: redhat-operators/' /opt/4.17-mirrordata/working-dir/cluster-resources/cc-redhat-operator-index-v4-17.yaml
            ```

        ```{ .yaml .no-copy title="Example: cs-redhat-operator-index-v4-17.yaml" hl_lines="4" }
        apiVersion: operators.coreos.com/v1alpha1
        kind: CatalogSource
        metadata:
          name: redhat-operators
          namespace: openshift-marketplace
        spec:
          image: registry.example.com:8443/ocp/redhat/redhat-operator-index:v4.17
          sourceType: grpc
        status: {}
        ```

        ```{ .yaml .no-copy title="Example: cc-redhat-operator-index-v4-19.yaml" hl_lines="8" }
        apiVersion: olm.operatorframework.io/v1
        kind: ClusterCatalog
        metadata:
          annotations:
            createdAt: Monday, 21-Jul-25 21:13:27 UTC
            createdBy: oc-mirror v2
            oc-mirror_version: 4.19.0-202507081507.p0.gf364aec.assembly.stream.el9-f364aec
          name: redhat-operators
        spec:
          priority: 0
          source:
            image:
              ref: registry.example.com:8443/ocp/redhat/redhat-operator-index:v4.19
            type: Image
        status: {}
        ```
  
  - `cs-certified-operator-index-v4-17.yaml`: This is the catalog for operators certified by Red Hat but not necessarily developed by Red Hat.
  - `cs-community-operator-index-v4-17.yaml`: This is the catalog source for all community based operators.

## Apply the cluster resources

[Red Hat Docs](https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/disconnected_environments/mirroring-in-disconnected-environments#oc-mirror-updating-cluster-manifests-v2_about-installing-oc-mirror-v2){:target="_blank"}

1. Apply the cluster recources generated by the oc-mirror plugin. This will make your cluster aware of the catalog resources we mirrored earlier so you can utilze OperatorHub to install operators.
```{ .bash }
oc apply -f /opt/4.17-mirrordata/working-dir/cluster-resources/
```
```{ . .no-copy title="Example Output" }
catalogsource.operators.coreos.com/cs-certified-operator-index-v4-17 created
catalogsource.operators.coreos.com/cs-community-operator-index-v4-17 created
catalogsource.operators.coreos.com/redhat-operators created
imagedigestmirrorset.config.openshift.io/idms-release-0 created
imagedigestmirrorset.config.openshift.io/idms-operator-0 created
imagetagmirrorset.config.openshift.io/itms-release-0 created
imagetagmirrorset.config.openshift.io/itms-generic-0 created
configmap/mirrored-release-signatures created
```

1. If you mirrored release images, apply the release image signatures
```{ .bash }
oc apply -f /opt/4.17-mirrordata/cluster-resources/signature-configmap.json
```