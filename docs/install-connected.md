## Low-side process 
[Docs](https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html/disconnected_environments/mirroring-in-disconnected-environments)

The general flow of a disconnected OpenShift install/update goes like this: 

1. Create an image set configuration file.
1. Mirror an image set to disk, transfer the image set to the target environment, then upload the image set to the target mirror registry.
1. Configure your cluster to use the resources generated by the oc-mirror plugin.
1. Repeat these steps to update your target mirror registry as necessary.


### Download necessary tools
Be aware of the tool(s) version and architecture. Certain tools require matching to the version of OpenShift you're installing and the correct binary for the RHEL version that you are using. 

- [https://console.redhat.com/openshift/downloads](https://console.redhat.com/openshift/downloads) has the latest version of all the tools. 
    - Look through the [public mirror site](https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/) if you need to get a specific version.
    - Or access specific versions through the [OpenShift Container Platform downloads page on the Red Hat Customer Portal](https://access.redhat.com/downloads/content/290)
    !!! info
        This document will go over the ways to check and verify that you have the correct packages before proceeding.
  ---

- **oc**: The OpenShift command line tool to interact with the cluster, also needed to use CLI plugins.
    - [Docs](https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html-single/cli_tools/index#cli-installing-cli_cli-developer-commands)
    - You can use the latest version available for your architecture. `oc` newer than your cluster version may have additional capabilities that your cluster cannot use.
  ---

- **oc-mirror**: Awesome oc plugin tool to streamline getting the required images to a `.tar` file to then transfer to the high-side.
    - [Docs](https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/disconnected_environments/mirroring-in-disconnected-environments#about-installing-oc-mirror-v2)
    - Always use the latest version available for your architecture.
    - **oc-mirror v2** is new, and GA'd for OpenShift 4.18, but is backwards compatible with older releases
    - RHEL 9: `$ wget https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/latest/oc-mirror.rhel9.tar.gz`
    - RHEL 8: `$ wget https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/latest/oc-mirror.tar.gz`
  ---

- **openshift-install**: Program that will create the OpenShift install disk that will bootstrap and install the cluster on your hardware. 
    
    !!! warning "Important"
        This binary is specific to the release version of OpenShit you are installing. The binary must match the release images that you mirror. 
    - We can acquire this binary on the low-side, or high-side. Steps will be included for both methods
  ---

- **mirror-registry** (optional): Small registry that can host the required container images to install, update, and maintain the cluster.
    - [Docs](https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html/disconnected_environments/mirroring-in-disconnected-environments#installing-mirroring-creating-registry)
    - Always use the latest version available for your architecture.
    - `$ wget https://mirror.openshift.com/pub/cgw/mirror-registry/latest/mirror-registry-amd64.tar.gz`
  ---

- **butane**: CLI tool to create machine config files to customize OpenShift nodes in your environment. 
    - [Docs](https://docs.redhat.com/en/documentation/openshift_container_platform/4.12/html/installation_configuration/installing-customizing#installation-special-config-butane-install_installing-customizing)
    - Always use the latest version available for your architecture.
    - `$ wget https://mirror.openshift.com/pub/openshift-v4/clients/butane/latest/butane-amd64`


### Install/configure tools

1. Put `oc` and `oc-mirror` tools we need on the low-side in your `$PATH`. Either `/usr/local/bin` or somewhere like `/home/$USER/bin` or `/home/$USER/.local/bin`
```bash
$ sudo tar -xzvf openshift-client-linux.tar.gz -C /usr/local/bin/
$ sudo tar -xzvf oc-mirror.tar.gz -C /usr/local/bin/ # RHEL 8
$ sudo tar -xzvf oc-mirror.rhel9.tar.gz -C /usr/local/bin/ # RHEL 9
$ sudo chmod +x /usr/local/bin/oc-mirror
```
1. Make sure you have set the umask parameter to `0022` on the operating system that uses oc-mirror
1. Verify that the oc-mirror v2 plugin is successfully installed by running the following command
```bash
$ oc mirror --v2 --help
```

### Grab your pull-secret from your Red Hat Account 
[Docs](https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html/disconnected_environments/mirroring-in-disconnected-environments#installation-adding-registry-pull-secret_installing-mirroring-disconnected)

1. Download or copy your `registry.redhat.io` [pull secret from the Red Hat OpenShift Cluster Manager](https://console.redhat.com/openshift/install/pull-secret). These are your credentials for accessing Red Hat container registries.

1. Make a copy of your pull secret in JSON format:
```bash
$ cat ./pull-secret | jq . > rh-pull-secret.json
``` 

3. Specify the path to the folder to store the pull secret in and a name for the JSON file that you create. You can store this file in `/home/$USER/.docker/config.json` or `$XDG_RUNTIME_DIR/containers/auth.json`. If one of the directories aren't there, create them.
    - The contents of the file resemble the following example:
```json
{
  "auths": {
    "cloud.openshift.com": {
      "auth": "b3BlbnNo...",
      "email": "you@example.com"
    },
    "quay.io": {
      "auth": "b3BlbnNo...",
      "email": "you@example.com"
    },
    "registry.connect.redhat.com": {
      "auth": "NTE3Njg5Nj...",
      "email": "you@example.com"
    },
    "registry.redhat.io": {
      "auth": "NTE3Njg5Nj...",
      "email": "you@example.com"
    }
  }
}
```

### Creating the image set configuration
1. Let's browse the catalog to determine what we want to download using `oc mirror`
    
    !!! tip 
        Some of these commands take time, and by default they print to stdout. You can send the outputs to a file e.g. '`oc mirror list operators > $(date +%F)-openshift-operators.txt`' or view the stdout in `.oc-mirror.log`. 
        
        The `.oc-mirror.log` file gets generated in the current directory you are at when you run oc mirror commands.

    - Using `oc mirror list releases` to list platform releases and versions
      
      ```bash
      # Output OpenShift release versions
      $ oc mirror list releases
  
      # Output all OpenShift release channels list for a release
      $ oc mirror list releases --version=4.17
  
      # List all OpenShift versions in a specified channel
      $ oc mirror list releases --channel=stable-4.17
  
      # List all OpenShift channels for a specific version
      $ oc mirror list releases --channels --version=4.17
  
      # List OpenShift channels for a specific version and one or more release architecture. 
      # Valid architectures: amd64 (default), arm64, ppc64le, s390x, multi.
       $ oc mirror list releases --channels --version=4.17 --filter-by-archs amd64,arm64,ppc64le,s390x,multi
      ```
    
    - Using `oc mirror list operators` to list available operator catalog content and versions
  
      ```bash
      # List available operator catalog release versions
      oc mirror list operators
  
      # Output default operator catalogs for OpenShift release 4.17
      oc mirror list operators --catalogs --version=4.17
  
      # List all operator packages in a catalog
      oc mirror list operators --catalog=catalog-name
  
      # List all channels in an operator package
      oc mirror list operators --catalog=catalog-name --package=package-name
  
      # List all available versions for a specified operator in a channel
      oc mirror list operators --catalog=catalog-name --package=operator-name --channel=channel-name
      ```

2. Initialize a image set template, it will take a minute or so. The template will default to latest content so we will modify it further to get what we want. Comments have been added to describe what these values mean. 
  
    [Docs](https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html-single/disconnected_environments/index#oc-mirror-creating-image-set-config_installing-mirroring-disconnected)

    - **imageset-config.yaml**: This is the file that tells `oc mirror` what images we want/need to download to have a fully functioning cluster. 
    - You can initialize a imageset-config using `oc mirror init > imageset-config.yaml`
      
    !!! info 
        As of this document `oc mirror init` generates a oc-mirror v1 formatted ics file (ImageSetConfiguration). We will be using oc-mirror v2 formatted ics moving forward for future proof sake.


3. Edit this file to define what you want to mirror. You can add comments to this file if you would like as it can get pretty messy. You can name the file anything you want as long as the yaml formatting is correct e.g. `4.17-imageset-config.yaml`. Be aware of yaml formatting, **spacing matters**
    
      - [Doc examples](https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html-single/disconnected_environments/index#oc-mirror-image-set-examples_installing-mirroring-disconnected)
      - The example below is for OpenShift 4.17 stable, with the lvms-operator to use node attached disks for persistent storage and cincinnati-operator to make cluster updating easier using graph data.
      
    !!! note "oc-mirror v2 changes"
        
        `apiVersion`: changes from *v1alpha2* to *v2alpha1*
        
        `storageConfig`: no longer needed as it's using a caching system rather than a metadata storage directory  
    
    Example:
    ```yaml title="imageset-config.yaml"
    kind: ImageSetConfiguration
    apiVersion: mirror.openshift.io/v2alpha1
    
    mirror:
      platform:
        channels:
        - name: stable-4.17 # (1)!
          type: ocp
        graph: true # (2)! 

      operators:
      - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.17 # (3)!
        packages:
        - name: lvms-operator # (4)!
          defaultChannel: stable-4.17 # (5)!
          channels:
          - name: stable-4.17 # (6)!
        - name: cincinnati-operator # (7)!
  
      additionalImages: # (8)!
      - name: registry.redhat.io/ubi8/ubi:latest
      - name: registry.redhat.io/openshift4/ose-must-gather:latest
      
      helm: {} # (9)!
    ```

    1. Defines that we want to download: OCP version 4.12 stable branch
    1. Graph data needed for the cincinnati operator
    1. Operator catalog we want to download from
    1. Operator that we want to download
    1. Some operators will need a defaultChannel specified. oc-mirror will tell you if it's required when attempting to mirror the data
    1. Version/Channel for said operators
    1. Only has one channel so just take the latest version
    1. Any additional images to bring with us, RHEL UBI's are always nice to have for testing, ose-must-gather is for gathering extra logs in the event a must gather is used for support
    1. Any additional helm charts, these are non-cataloged application bundles more or less
    
### Mirroring images to disk
[Docs](https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html/disconnected_environments/mirroring-in-disconnected-environments#mirror-to-disk-v2_about-installing-oc-mirror-v2)

Now that the images are defined, we can mirror them to disk

- Pass in the image set configuration file that was created. This procedure assumes that it is named `imageset-config.yaml`. If you named your's differently, sub in your name of the file.
- Specify the target directory where you want to output the image set tar file. The target directory path must start with `file://`. This procedure assumes you want to store the image set in `/opt/4.17-mirrordata`. Store it anywhere that has available disk space. Can even be the mounted drive you're going to use to transfer the data to the high-side.
  - The target directory will also hold the `working-dir` environment. This directory contains the various necessary data to build, update, and maintain cluster resources. Keep this directory safe, and do not modify it. It will be used again for updates and additions to your cluster
- Be aware of the caching system, this will also take up considerable space on the disk depending on how many images you want to mirror
  > - How does the cache work?:
  >   - It's like a local registry, it can take up additional disk space almost as large as the .tar that gets generated
  > - Where is it saved?
  >   - By default in `$HOME/.oc-mirror/.cache`
  > - Can I control where I want the cache to be stored?
  >   - Yes, you can pass `--cache-dir <dir>` which will change the cache location to `<dir>/.oc-mirror/.cache`
  > - During the mirroring process, is there a way to resume if something goes wrong?
  >   - Yes, by re-running oc mirror
  > - I intentionally canceled the task and re-ran the mirroring process, but it seemed to start from the beginning.
  >   - It goes through the images from your ISC but it won't pull them if they're already in the cache. You can compare the elapsed times by running a second time with the images already cached.
  > - The cache takes up a lot of disk space can it be deleted?
  >   - Yes the cache can be removed, oc mirror will just re-download what's needed
---
1. Perform the mirror to disk process    
    ```bash
    $ oc mirror -c imageset-config.yaml file:///opt/4.17-mirrordata --v2
    ...
    [INFO]   : === Results ===
    [INFO]   :  ✓  185 / 185 release images mirrored successfully
    [INFO]   :  ✓  8 / 8 operator images mirrored successfully
    [INFO]   :  ✓  1 / 1 additional images mirrored successfully
    [INFO]   : 📦 Preparing the tarball archive...
    [INFO]   : mirror time     : 13m31.071692892s
    [INFO]   : 👋 Goodbye, thank you for using oc-mirror
    ```
    
1. Navigate to your output directory and verify the image set `mirror_000001.tar` file was created
    ```bash
    $ cd /opt/4.17-mirrordata/
    $ ls
    mirror_000001.tar  working-dir
    ```

1. Look at the `working-dir` that was generated from the mirror task
    - This directory contains the various necessary data to build, update, and maintain cluster resources
    - Keep this directory safe, and do not modify it. It will be used again for updates and additions to your cluster resources
    ```bash
    $ tree -a -L 2
    .
    ├── mirror_000001.tar
    └── working-dir
        ├── cluster-resources
        ├── graph-preparation
        ├── helm
        ├── .history
        ├── hold-operator
        ├── hold-release
        ├── logs
        ├── operator-catalogs
        ├── release-images
        └── signatures
    ```
  
#### Extract the openshift-install binary from the release-images mirrored
To extract the openshift-install that's built for your mirrored images version on the low side

1. Construct the correct URL to download the payload for your release images. Follow one of these steps
    
    1. Using oc-mirror v2 directory structure, we get the hash from the images we mirrored to disk
    ```bash
    $ ls working-dir/signatures/4.17.70-x86_64-sha256-d9c985464c0315160971b3e79f5fbec628d403a572f7a6d893c04627c066c0bb | awk -F'sha256-' '{print $2}'
    {==40a0dce2a37e3278adc2fd64f63bca67df217b7dd8f68575241b66fdae1f04a3==}

    # Store this in a variable so we can use it to curate the URL to extract the installer from without copying and pasting 
    $ export VERSION=$(ls working-dir/signatures/4.17.70-x86_64-sha256-40a0dce2a37e3278adc2fd64f63bca67df217b7dd8f68575241b66fdae1f04a3 | awk -F'sha256-' '{print $2}')
    ```
    2. For both oc-mirror v1/2, we can construct the entire URL based on the version we specified in the imageset config file. Read the warning below to understand the potential issue you could run into.
    ```bash
    $ export VERSION=stable-4.17
    $ export RELEASE_ARCH=amd64
    $ export RELEASE_IMAGE=$(curl -s https://mirror.openshift.com/pub/openshift-v4/$RELEASE_ARCH/clients/ocp/$VERSION/release.txt | grep 'Pull From: quay.io' | awk -F ' ' '{print $3}')
    $ echo $RELEASE_IMAGE
    quay.io/openshift-release-dev/ocp-release@sha256:{==40a0dce2a37e3278adc2fd64f63bca67df217b7dd8f68575241b66fdae1f04a3==}
    ```
    !!! warning
        Be aware that this could end up downloading a different version of installer if you mirrored the images at a earlier time.

        Example: You mirrored the images a week ago, now you go to extract the binary, but Red Hat updated the `stable-4.17` images from `4.17.70` to `4.17.71`. The binary would be downloaded for the newer stable branch and be the incorrect version with the images you mirrored prior.

2. Use `oc adm` to extract the openshift-install binary that is purpose built for the version of images you mirrored. This command will extract the `openshift-install` or `openshift-install-fips` binary to your current directory. You can pass in the `--dir='<path>'` to extract the binary to a specific location on your filesystem. 
    ```bash
    $ oc adm release extract --command=openshift-install quay.io/openshift-release-dev/ocp-release@sha256:$VERSION
    ```
      - If you are installing OpenShift 4.16 or later and requiring FIPS, change the `--command=openshift-install` to `--command=openshift-install-fips`
    ```bash
    $ oc adm release extract --command=openshift-install-fips quay.io/openshift-release-dev/ocp-release@sha256:$VERSION
    ```
    - If you constructed the entire URL
    ```bash
    $ oc adm release extract --command=openshift-install $RELEASE_IMAGE
    ```
3. Now check the SHA256 against the release signatures we looked at before by running `./openshift-install version`
    ```bash
    $ ./openshift-install version
    ./openshift-install 4.12.70
    built from commit 798aeaaf61fbc22669b6bad2edc058ea6949d733
    release image quay.io/openshift-release-dev/ocp-release@sha256:{==40a0dce2a37e3278adc2fd64f63bca67df217b7dd8f68575241b66fdae1f04a3==}
    release architecture amd64
    ```
4. If the SHA256 values match each other, then you have extracted the correct `openshift-install` binary that can build your cluster with the release images you mirrored.

### Transfer data and tools to the disconnected environment (high-side).
Place these files on a disk and transfer them to your disconnected network

- **mirror_000001.tar** (image set .tar file)
- **imageset-config.yaml** (your image set config file)
- **oc**
- **oc-mirror**
- **butane**
- **mirror-registry** (if using)
- **openshift-install** (if extracting the binary from the low-side)

---

